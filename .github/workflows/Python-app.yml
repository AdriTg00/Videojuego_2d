name: Build Qt Application

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest   # Genera el .exe en Windows

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      shell: pwsh
      run: |
        python -m pip install --upgrade pip

        if (Test-Path -Path "requirements.txt") {
          pip install -r requirements.txt
        } else {
          Write-Host "No requirements.txt found"
        }

        # Dependencias necesarias para el build
        pip install pyinstaller PySide6 requests

    - name: Build executable (from Ventana_Principal_TFG)
      working-directory: Ventana_Principal_TFG
      shell: pwsh
      run: |
        python -m PyInstaller main.py `
          --onefile `
          --noconsole `
          --name Launcher_Videojuego `
          --collect-submodules dao `
          --collect-submodules services `
          --collect-submodules controller `
          --collect-submodules model `
          --collect-submodules views `
          --collect-submodules widgets `
          --collect-submodules workers `
          --hidden-import requests `
          --hidden-import PySide6.QtCore `
          --hidden-import PySide6.QtGui `
          --hidden-import PySide6.QtWidgets `
          --exclude-module PySide6.QtWebEngine `
          --exclude-module PySide6.QtWebEngineCore `
          --exclude-module PySide6.QtWebEngineWidgets `
          --exclude-module PySide6.QtQml `
          --exclude-module PySide6.QtQuick `
          --exclude-module PySide6.QtQuickWidgets `
          --exclude-module PySide6.QtMultimedia `
          --exclude-module PySide6.QtMultimediaWidgets `
          --exclude-module PySide6.Qt3DAnimation `
          --exclude-module PySide6.Qt3DCore `
          --exclude-module PySide6.Qt3DRender `
          --exclude-module PySide6.Qt3DExtras `
          --exclude-module PySide6.QtBluetooth `
          --exclude-module PySide6.QtPdf `
          --exclude-module PySide6.QtPdfWidgets `
          --exclude-module PySide6.QtCharts `
          --exclude-module PySide6.QtSvg `
          --exclude-module PySide6.QtSvgWidgets `
          --exclude-module PySide6.QtSql `
          --exclude-module PySide6.QtSensors `
          --exclude-module PySide6.QtWebSockets `
          --exclude-module PySide6.QtPositioning `
          --exclude-module PySide6.QtLocation `
          --exclude-module PySide6.QtNetworkAuth

        Write-Host "Contenido de Ventana_Principal_TFG:"
        dir

        Write-Host "Contenido de dist:"
        if (Test-Path -Path dist) {
          dir dist
        } else {
          Write-Host "No existe carpeta dist (fall√≥ PyInstaller)"
        }

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: Launcher_Videojuego_exe
        path: Ventana_Principal_TFG/dist/Launcher_Videojuego.exe
